<!DOCTYPE html>
<html>
<head>
    <title>幾徳祭 オリジナルMAP</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        html, body { height: 100%; margin: 0; }
        #map { width: 100%; height: 100%; }
        .building-label {
            background-color: transparent;
            border: none;
            box-shadow: none;
            font-weight: bold;
            font-size: 14px;
            color: #333;
            text-shadow: 1px 1px 2px white;
        }
        /* 模擬店ラベル用のCSS */
        .stall-label {
            background-color: transparent;
            border: none;
            box-shadow: none;
            font-weight: bold;
            font-size: 12px;
            color: black;
            text-shadow: 1px 1px 1px white;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script>

    // ★ test_map.html から持ってきた回転四角形を計算する関数
    function createRotatedRectangle(centerLatLng, widthMeters, heightMeters, angleDegrees) {
        const centerLat = centerLatLng.lat;
        const centerLng = centerLatLng.lng;
        const R = 6378137; // 地球の半径 (メートル)
        const latRad = centerLat * Math.PI / 180;
        const metersPerDegreeLat = 1 / ((Math.PI / 180) * R);
        const metersPerDegreeLng = 1 / ((Math.PI / 180) * R * Math.cos(latRad));
        const halfWidthDegrees = (widthMeters / 2) * metersPerDegreeLng;
        const halfHeightDegrees = (heightMeters / 2) * metersPerDegreeLat;
        const angleRad = angleDegrees * Math.PI / 180;
        const cosAngle = Math.cos(angleRad);
        const sinAngle = Math.sin(angleRad);
        const corners = [];
        const points = [
            {x: -halfWidthDegrees, y: halfHeightDegrees},
            {x: halfWidthDegrees, y: halfHeightDegrees},
            {x: halfWidthDegrees, y: -halfHeightDegrees},
            {x: -halfWidthDegrees, y: -halfHeightDegrees}
        ];
        points.forEach(p => {
            const rotatedX = p.x * cosAngle - p.y * sinAngle;
            const rotatedY = p.x * sinAngle + p.y * cosAngle;
            corners.push(L.latLng(centerLat + rotatedY, centerLng + rotatedX));
        });
        return corners;
    }

    // 1. マップの初期化
    const map = L.map('map').setView([35.486381, 139.341857], 20);

    // 2. 地図タイルを読み込み
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap contributors © CARTO',
        maxZoom: 20
    }).addTo(map);

    // 3. 建物ラベルを追加
    const libraryLabel = L.divIcon({ className: 'building-label', html: '<b>図書館</b>', iconSize: [100, 20] });
    L.marker([35.487163, 139.341781], { icon: libraryLabel }).addTo(map);
    const kaitKoboLabel = L.divIcon({ className: 'building-label', html: '<b>KAIT工房</b>', iconSize: [100, 20] });
    L.marker([35.486725, 139.342473], { icon: kaitKoboLabel }).addTo(map);


    // 4. 模擬店を追加 (ここからが本番！)
    // ★ 模擬店の情報を配列で一元管理 ★
    const stallData = [
        {
            name: 'ﾔｷﾄﾘﾋﾟｱ',
            center: [35.486313, 139.341941], // 中心座標
            width: 8,      // 横幅 (メートル)
            height: 4,    // 縦幅 (メートル)
            angle: 4,      // 回転角度 (度)
            color: "#ff7800",
            popupContent: `<h3>KAITpia やきとりピア</h3><b>価格:</b> 00円<br>たくさん上手に焼けました！`
        },
        {
            name: 'ﾊﾘｹｰﾝ</br>ﾎﾟﾃﾄ屋',
            center: [35.486318, 139.342032], // 中心座標
            width: 8,      // 横幅 (メートル)
            height: 4,    // 縦幅 (メートル)
            angle: 4,      // 回転角度 (度)
            color: "#ff7800",
            popupContent: `<h3>岡崎研究室 ハリケーンポテト屋</h3><b>価格:</b> 00円<br>味も映ばえも満点のハリケーンポテト,絶対食べて!!`
        },
        {
            name: '焼売',
            center: [35.486402, 139.341932],
            width: 8,
            height: 4,
            angle: 4,
            color: "#e31a1c",
            popupContent: `<h3>バレーボールサークル フランクフルト</h3><b>価格:</b> 00円<br>肉の旨味たっぷり焼売！！`
        },
        {
            name: 'ﾌﾗﾝｸﾌﾙﾄ',
            center: [35.486407, 139.342020],
            width: 8,
            height: 4,
            angle: 4,
            color: "#e31a1c",
            popupContent: `<h3>岡本剛研究室 フランクフルト</h3><b>価格:</b> 00円<br>アツアツ！ジューシーなフランクフルト`
        },
        // さらに追加したい場合は、ここにオブジェクトを追加します
        // {
        //     name: 'わたあめ',
        //     center: [35.48635, 139.34165],
        //     width: 8,
        //     height: 8,
        //     angle: 45, // 45度回転させる
        //     color: "#FFC0CB",
        //     popupContent: `<h3>□□サークル わたあめ</h3><b>価格:</b> 200円<br>ふわふわです！`
        // }
    ];

    // ★ 配列をループして、すべての模擬店を地図に追加 ★
    stallData.forEach(stall => {
        // 1. 中心のLatLngオブジェクトを作成
        const center = L.latLng(stall.center[0], stall.center[1]);
        
        // 2. 関数を使って四角形の頂点座標を計算
        const corners = createRotatedRectangle(center, stall.width, stall.height, stall.angle);
        
        // 3. L.polygonで四角形を作成して地図に追加
        L.polygon(corners, {
            color: stall.color,
            weight: 2,
        })
        .addTo(map)
        .bindTooltip(stall.name, {
            permanent: true,
            direction: 'center',
            className: 'stall-label'
        })
        .bindPopup(stall.popupContent);
    });

// --- ↓↓↓ ここから追加 ↓↓↓ ---
// ★★★ 位置合わせを簡単にするためのヘルパー機能 ★★★

// 角度計算のための1点目の座標を保存する変数
let firstClickPoint = null;

// マップがクリックされたときのイベント
map.on('click', function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    // --- 1. 中心座標の取得 ---
    // 常にクリックした場所の座標をコンソールに出力する
    console.log(`【中心座標】 center: [${lat.toFixed(6)}, ${lng.toFixed(6)}],`);

    // --- 2. 角度の取得 ---
    if (firstClickPoint === null) {
        // 1回目のクリック
        firstClickPoint = e.latlng;
        console.log('▲ 1点目をクリックしました。次はテントの向きがわかるように、辺に沿ってもう1点クリックしてください。');
    } else {
        // 2回目のクリック
        const lat1 = firstClickPoint.lat;
        const lng1 = firstClickPoint.lng;
        const lat2 = e.latlng.lat;
        const lng2 = e.latlng.lng;

        // 2点間の角度を計算（地面に平行な東向きが0度）
        const y = lat2 - lat1;
        // 緯度によって経度1度あたりの距離が変わるのを補正
        const x = (lng2 - lng1) * Math.cos(lat1 * Math.PI / 180); 
        
        let angle = Math.atan2(y, x) * (180 / Math.PI);
        
        console.log(`【角度】 angle: ${angle.toFixed(2)},`);
        console.log('--------------------------------------');

        // 1点目のクリック情報をリセット
        firstClickPoint = null;
    }
});
</script>

</body>
</html>